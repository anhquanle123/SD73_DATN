<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{user/layout-user.html}">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết sản phẩm</title>

    <link rel="icon" type="image/png" th:href="@{/images/icons/sneaker.png}"/>
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" th:href="@{/vendor/bootstrap/css/bootstrap.min.css}"/>
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" th:href="@{/fonts/font-awesome-4.7.0/css/font-awesome.min.css}"/>
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" th:href="@{/fonts/iconic/css/material-design-iconic-font.min.css}"/>
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" th:href="@{/fonts/linearicons-v1.0.0/icon-font.min.css}"/>
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" th:href="@{/vendor/animate/animate.css}"/>
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" th:href="@{/vendor/css-hamburgers/hamburgers.min.css}"/>
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" th:href="@{/vendor/animsition/css/animsition.min.css}"/>
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" th:href="@{/vendor/select2/select2.min.css}"/>
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" th:href="@{/vendor/daterangepicker/daterangepicker.css}"/>
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/c ss" th:href="@{/vendor/slick/slick.css}"/>
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" th:href="@{/vendor/MagnificPopup/magnific-popup.css}"/>
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" th:href="@{/vendor/perfect-scrollbar/perfect-scrollbar.css}"/>
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" th:href="@{/css/util.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/main.css}"/>
    <style>
        .size-box, .color-box {
            display: inline-block;
            padding: 10px 15px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            min-width: 50px;
            background-color: #fff;
            transition: all 0.3s;
        }
        .size-box:hover, .color-box:hover {
            background-color: #f1f1f1;
        }
        .size-box.selected, .color-box.selected {
            background-color: #717fe0;
            color: #fff;
            border-color: #717fe0;
        }
        .size-box.disabled, .color-box.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="z-index: 99999">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Yêu cầu đăng nhập</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Vui lòng đăng nhập để tiếp tục sử dụng chức năng này.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    <a href="/user-login" class="btn btn-primary">Đăng nhập</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Detail -->
    <section class="sec-product-detail bg0 p-t-65 p-b-60">
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-lg-7 p-b-30">
                    <div class="p-l-25 p-r-30 p-lr-0-lg">
                        <div class="wrap-slick3 flex-sb flex-w">
                            <div class="wrap-slick3-dots"></div>
                            <div class="wrap-slick3-arrows flex-sb-m flex-w"></div>
                            <div class="slick3 gallery-lb">
                                <th:block th:each="image : ${product.image}">
                                    <div class="item-slick3" th:data-thumb="'/' + ${image.link}">
                                        <div class="wrap-pic-w pos-relative">
                                            <img th:src="@{'/' + ${image.link}}" alt="IMG-PRODUCT" />
                                            <a class="flex-c-m size-108 how-pos1 bor0 fs-16 cl10 bg0 hov-btn3 trans-04"
                                               th:href="@{'/' + ${image.link}}">
                                                <i class="fa fa-expand"></i>
                                            </a>
                                        </div>
                                    </div>
                                </th:block>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-5 p-b-30">
                    <div class="p-r-50 p-t-5 p-lr-0-lg">
                        <h4 class="mtext-105 cl2 js-name-detail p-b-14" th:text="${product.name}"></h4>
                        <span class="mtext-106 cl2" id="price_product" th:text="${#numbers.formatDecimal(product.productDetails[0].price, 0, 'POINT', 0, 'COMMA') + ' đ'}"></span>
                        <p class="stext-102 cl3 p-t-23" th:text="${product.describe}">
                            Một kết hợp từ sự thoải mái cùng độ ấm áp trong thiết kế cổ lọ.
                        </p>
                        <p class="stext-102 cl3 p-t-23">
                            <span><i class="fa fa-copyright"></i></span>&nbsp;Nhãn hiệu: <span class="font-weight-bold" th:text="${product.brand.name}"></span><br>
                            <span><i class="fa fa-puzzle-piece"></i></span>&nbsp;Chất liệu: <span class="font-weight-bold" th:text="${product.material.name}"></span><br>
                            <span><i class="fa fa-cubes"></i></span>&nbsp;Loại: <span class="font-weight-bold" th:text="${product.category.name}"></span><br>
                        </p>

                        <!-- Size Selection -->
                        <div class="p-t-33">
                            <div class="flex-w flex-r-m p-b-10">
                                <div class="size-203 respon6">
                                    Kích cỡ
                                </div>
                                <div class="size-204 respon6-next">
                                    <div class="size-box-container" id="sizeBoxContainer">
                                        <!-- Size boxes will be dynamically loaded here -->
                                    </div>
                                    <input type="hidden" id="sizeSelect" name="size">
                                </div>
                            </div>

                            <!-- Color Selection -->
                            <div class="flex-w flex-r-m p-b-10">
                                <div class="size-203 respon6">
                                    Màu
                                </div>
                                <div class="size-204 respon6-next">
                                    <div class="color-box-container" id="colorBoxContainer">
                                        <!-- Color boxes will be dynamically loaded here -->
                                    </div>
                                    <input type="hidden" id="colorSelect" name="color">
                                </div>
                            </div>
                            <input type="hidden" name="productDetailId" id="productDetailId">
                            <div class="flex-w flex-r-m p-b-10">
                                <div class="size-204 flex-w flex-m respon6-next">
                                    <div class="wrap-num-product flex-w m-r-20 m-tb-10">
                                        <div class="btn-num-product-down cl8 hov-btn3 trans-04 flex-c-m">
                                            <i class="fs-16 zmdi zmdi-minus"></i>
                                        </div>
                                        <input class="mtext-104 cl3 txt-center num-product" type="number"
                                               name="num-product" value="1">
                                        <div class="btn-num-product-up cl8 hov-btn3 trans-04 flex-c-m">
                                            <i class="fs-16 zmdi zmdi-plus"></i>
                                        </div>
                                    </div>
                                    <span class="remaning-product" style="font-size: 12px"></span>
                                    <button class="flex-c-m stext-101 cl0 size-101 bg1 bor1 hov-btn1 p-lr-15 trans-04 js-addcart-detail">
                                        Thêm vào giỏ
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Social Sharing -->
                        <div class="flex-w flex-m p-l-100 p-t-40 respon7">
                            <div class="flex-m bor9 p-r-10 m-r-11">
                                <a href="#" class="fs-14 cl3 hov-cl1 trans-04 lh-10 p-lr-5 p-tb-2 js-addwish-detail tooltip100"
                                   data-tooltip="Thêm vào danh sách yêu thích">
                                    <i class="zmdi zmdi-favorite"></i>
                                </a>
                            </div>
                            <a href="#" class="fs-14 cl3 hov-cl1 trans-04 lh-10 p-lr-5 p-tb-2 m-r-8 tooltip100"
                               data-tooltip="Facebook">
                                <i class="fa fa-facebook"></i>
                            </a>
                            <a href="#" class="fs-14 cl3 hov-cl1 trans-04 lh-10 p-lr-5 p-tb-2 m-r-8 tooltip100"
                               data-tooltip="Twitter">
                                <i class="fa fa-twitter"></i>
                            </a>
                            <a href="#" class="fs-14 cl3 hov-cl1 trans-04 lh-10 p-lr-5 p-tb-2 m-r-8 tooltip100"
                               data-tooltip="Google Plus">
                                <i class="fa fa-google-plus"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Back to top -->
    <div class="btn-back-to-top" id="myBtn">
        <span class="symbol-btn-back-to-top">
            <i class="zmdi zmdi-chevron-up"></i>
        </span>
    </div>

    <!-- Modal1 -->
    <div class="wrap-modal1 js-modal1 p-t-60 p-b-20">
        <div class="overlay-modal1 js-hide-modal1"></div>
        <div class="container">
            <div class="bg0 p-t-60 p-b-30 p-lr-15-lg how-pos3-parent">
                <button class="how-pos3 hov3 trans-04 js-hide-modal1">
                    <img src="images/icons/icon-close.png" alt="CLOSE">
                </button>
                <div class="row">
                    <div class="col-md-6 col-lg-7 p-b-30">
                        <div class="p-l-25 p-r-30 p-lr-0-lg">
                            <div class="wrap-slick3 flex-sb flex-w">
                                <div class="wrap-slick3-dots"></div>
                                <div class="wrap-slick3-arrows flex-sb-m flex-w"></div>
                                <div class="slick3 gallery-lb">
                                    <div class="item-slick3" data-thumb="images/product-detail-01.jpg">
                                        <div class="wrap-pic-w pos-relative">
                                            <img src="images/product-detail-01.jpg" alt="IMG-PRODUCT">
                                            <a class="flex-c-m size-108 how-pos1 bor0 fs-16 cl10 bg0 hov-btn3 trans-04"
                                               href="images/product-detail-01.jpg">
                                                <i class="fa fa-expand"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="item-slick3" data-thumb="images/product-detail-02.jpg">
                                        <div class="wrap-pic-w pos-relative">
                                            <img src="images/product-detail-02.jpg" alt="IMG-PRODUCT">
                                            <a class="flex-c-m size-108 how-pos1 bor0 fs-16 cl10 bg0 hov-btn3 trans-04"
                                               href="images/product-detail-02.jpg">
                                                <i class="fa fa-expand"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="item-slick3" data-thumb="images/product-detail-03.jpg">
                                        <div class="wrap-pic-w pos-relative">
                                            <img src="images/product-detail-03.jpg" alt="IMG-PRODUCT">
                                            <a class="flex-c-m size-108 how-pos1 bor0 fs-16 cl10 bg0 hov-btn3 trans-04"
                                               href="images/product-detail-03.jpg">
                                                <i class="fa fa-expand"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-5 p-b-30">
                        <div class="p-r-50 p-t-5 p-lr-0-lg">
                            <h4 class="mtext-105 cl2 js-name-detail p-b-14">
                                
                            </h4>
                            <span class="mtext-106 cl2">
                                $58.79
                            </span>
                            <p class="stext-102 cl3 p-t-23">
                                Với cách phối màu khác kết hợp với đường viền ở đế giày và cổ giày đã làm thiết kế trở nên nổi bật và trẻ trung hơn. Chi tiết giày được may bên trong đã thể hiện được sự tinh tế của thiết kế khi vừa giữ được tính thẩm mỹ cho sản phẩm này
                            </p>
                            <div class="p-t-33">
                                <div class="flex-w flex-r-m p-b-10">
                                    <div class="size-203 flex-c-m respon6">
                                        Kích cỡ
                                    </div>
                                    <div class="size-204 respon6-next">
                                        <div class="size-box-container" id="modalSizeBoxContainer">
                                            <!-- Modal size boxes will be dynamically loaded here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="flex-w flex-r-m p-b-10">
                                    <div class="size-203 flex-c-m respon6">
                                        Màu
                                    </div>
                                    <div class="size-204 respon6-next">
                                        <div class="color-box-container" id="modalColorBoxContainer">
                                            <!-- Modal color boxes will be dynamically loaded here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="flex-w flex-r-m p-b-10">
                                    <div class="size-204 flex-w flex-m respon6-next">
                                        <div class="wrap-num-product flex-w m-r-20 m-tb-10">
                                            <div class="btn-num-product-down cl8 hov-btn3 trans-04 flex-c-m">
                                                <i class="fs-16 zmdi zmdi-minus"></i>
                                            </div>
                                            <input class="mtext-104 cl3 txt-center num-product" type="number"
                                                   name="num-product" value="1">
                                            <div class="btn-num-product-up cl8 hov-btn3 trans-04 flex-c-m">
                                                <i class="fs-16 zmdi zmdi-plus"></i>
                                            </div>
                                        </div>
                                        <button class="flex-c-m stext-101 cl0 size-101 bg1 bor1 hov-btn1 p-lr-15 trans-04 js-addcart-detail">
                                            Thêm vào giỏ
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-w flex-m p-l-100 p-t-40 respon7">
                                <div class="flex-m bor9 p-r-10 m-r-11">
                                    <a href="#" class="fs-14 cl3 hov-cl1 trans-04 lh-10 p-lr-5 p-tb-2 js-addwish-detail tooltip100"
                                       data-tooltip="Thêm vào danh sách yêu thích">
                                        <i class="zmdi zmdi-favorite"></i>
                                    </a>
                                </div>
                                <a href="#" class="fs-14 cl3 hov-cl1 trans-04 lh-10 p-lr-5 p-tb-2 m-r-8 tooltip100"
                                   data-tooltip="Facebook">
                                    <i class="fa fa-facebook"></i>
                                </a>
                                <a href="#" class="fs-14 cl3 hov-cl1 trans-04 lh-10 p-lr-5 p-tb-2 m-r-8 tooltip100"
                                   data-tooltip="Twitter">
                                    <i class="fa fa-twitter"></i>
                                </a>
                                <a href="#" class="fs-14 cl3 hov-cl1 trans-04 lh-10 p-lr-5 p-tb-2 m-r-8 tooltip100"
                                   data-tooltip="Google Plus">
                                    <i class="fa fa-google-plus"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" th:inline="javascript"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        var productId = /*[[${product.id}]]*/ 'default-value';
        var productCode = /*[[${product.code}]]*/ 'default-value';
        var isUserLoggedIn = /*[[${#authorization.expression('isAuthenticated()')}]]*/ 'abc';

        $.ajax({
            type: 'GET',
            dataType: "json",
            url: "/colors/" + productId + "/" + "product",
            success: function (data) {
                loadColorBoxes(data);
            }
        });

        $.ajax({
            type: 'GET',
            dataType: "json",
            url: "/sizes/" + productId + "/" + "product",
            success: function (data) {
                loadSizeBoxes(data);
            }
        });

        async function handleColorChange(colorId) {
            if (!colorId) {
                enableAllSizeBoxes();
                enableAllColorBoxes();
                $("#colorSelect").val('');
                return;
            }
            $('#loading-overlay').show();
            await $.ajax({
                type: 'GET',
                dataType: "json",
                url: `/sizes/${productId}/product/${colorId}/color`,
                success: function (data) {
                    enableAllSizeBoxes();
                    var availableSizes = data.map(function (size) {
                        return size.id;
                    });
                    $('.size-box').each(function () {
                        var sizeId = $(this).data('size-id');
                        if (!availableSizes.includes(sizeId)) {
                            disableSizeBox(sizeId);
                        }
                    });
                    if ($("#sizeSelect").val()) {
                        loadPrice();
                    }
                }
            });
            $('#loading-overlay').hide();
        }

        async function handleSizeChange(sizeId) {
            if (!sizeId) {
                enableAllColorBoxes();
                enableAllSizeBoxes();
                $("#sizeSelect").val('');
                return;
            }
            $('#loading-overlay').show();
            await $.ajax({
                type: 'GET',
                dataType: "json",
                url: `/colors/${productId}/product/${sizeId}/size`,
                success: function (data) {
                    enableAllColorBoxes();
                    var availableColors = data.map(function (color) {
                        return color.id;
                    });
                    $('.color-box').each(function () {
                        var colorId = $(this).data('color-id');
                        if (!availableColors.includes(colorId)) {
                            disableColorBox(colorId);
                        }
                    });
                    if ($("#colorSelect").val()) {
                        loadPrice();
                    }
                }
            });
            $('#loading-overlay').hide();
        }

        $(document).ready(function () {
            $(document).on('click', '.size-box:not(.disabled)', function () {
                $('.size-box').removeClass('selected');
                $(this).addClass('selected');
                var sizeId = $(this).data('size-id');
                $("#sizeSelect").val(sizeId);
                handleSizeChange(sizeId);
            });

            $(document).on('click', '.color-box:not(.disabled)', function () {
                $('.color-box').removeClass('selected');
                $(this).addClass('selected');
                var colorId = $(this).data('color-id');
                $("#colorSelect").val(colorId);
                handleColorChange(colorId);
            });

            $(".js-addcart-detail").on('click', function (e) {
                if (!isUserLoggedIn) {
                    $('#loginModal').modal('show');
                    localStorage.setItem("redirect", `/product-detail/${productCode}`);
                } else {
                    addToCart();
                }
            });
        });

        function formatNumber(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function enableAllColorBoxes() {
            $('.color-box').removeClass('disabled');
        }

        function enableAllSizeBoxes() {
            $('.size-box').removeClass('disabled');
        }

        function disableColorBox(colorId) {
            $(`.color-box[data-color-id='${colorId}']`).addClass('disabled');
        }

        function disableSizeBox(sizeId) {
            $(`.size-box[data-size-id='${sizeId}']`).addClass('disabled');
        }

        function loadColorBoxes(data) {
            var container = document.getElementById("colorBoxContainer");
            var modalContainer = document.getElementById("modalColorBoxContainer");
            container.innerHTML = '';
            modalContainer.innerHTML = '';
            for (var i = 0; i < data.length; i++) {
                var box = document.createElement("span");
                box.className = "color-box";
                box.setAttribute("data-color-id", data[i].id);
                box.textContent = data[i].name;
                container.appendChild(box);
                modalContainer.appendChild(box.cloneNode(true));
            }
        }

        function loadSizeBoxes(data) {
            var container = document.getElementById("sizeBoxContainer");
            var modalContainer = document.getElementById("modalSizeBoxContainer");
            container.innerHTML = '';
            modalContainer.innerHTML = '';
            for (var i = 0; i < data.length; i++) {
                var box = document.createElement("span");
                box.className = "size-box";
                box.setAttribute("data-size-id", data[i].id);
                box.textContent = data[i].name;
                container.appendChild(box);
                modalContainer.appendChild(box.cloneNode(true));
            }
        }

        async function loadPrice() {
            await $.ajax({
                type: 'GET',
                dataType: "json",
                url: `/productDetails/${productId}/product`,
                success: function (data) {
                    const productDetail = data.find(item => item.size.id == $("#sizeSelect").val() && item.color.id == $("#colorSelect").val());
                    loadRemainingQuantity(productDetail.quantity);
                    if (!productDetail.discountedPrice) {
                        $("#price_product").text(formatNumber(parseFloat(productDetail.price)) + ' đ');
                    } else {
                        const oldPrice = formatNumber(parseFloat(productDetail.price));
                        const discountedPrice = formatNumber(parseFloat(productDetail.discountedPrice));
                        $("#price_product").html(`
                            <span style="font-size: 12px; text-decoration: line-through">${oldPrice} đ</span>
                            <span class="mtext-106 cl2">${discountedPrice} đ</span>
                        `);
                    }
                    $("#productDetailId").val(productDetail.id);
                }
            });
        }

        function loadRemainingQuantity(value) {
            if (value == 0) {
                $('.js-name-detail').append('<span style="color:red; border: 1px solid #ddd; font-size: 12px; margin-left: 8px">Hết hàng</span>');
            }
            $(".remaning-product").html(`Còn lại <span id="remaining-quantity" data-quantity="${value}">${value}</span> sản phẩm`);
        }

        $('.num-product').on('keypress', function (e) {
            onlyAllowNumberInput(e);
        });

        $('.num-product').on('focusout', function (e) {
            if ($(this).val() == "") {
                $(this).val(1);
            }
        });

        function onlyAllowNumberInput(e) {
            const key = e.key;
            if (key === '-' || key == '0') {
                e.preventDefault();
            }
        }

        async function addToCart() {
            var remainingQuantity = parseInt($("#remaining-quantity").attr('data-quantity'));
            var quantity = parseInt($('.num-product').val());
            if (!checkColorAndSizeSelect()) {
                return;
            }
            if (remainingQuantity == 0) {
                swal("Lỗi", "Sản phẩm có thuộc tính này đã hết hàng", "error");
                return;
            }
            if (quantity > remainingQuantity) {
                swal("Lỗi", "Số lượng thêm vào giỏ hàng lớn hơn số lượng còn", "error");
                return;
            }
            var nameProduct = $('.js-name-detail').text();
            var dataSend = {
                detail: {
                    id: $("#productDetailId").val()
                },
                quantity: quantity
            };
            $('#loading-overlay').show();
            await $.ajax({
                type: 'POST',
                url: '/api/addToCart',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(dataSend),
                success: function (data) {
                    $('#loading-overlay').hide();
                    swal(nameProduct, "Thêm vào giỏ hàng thành công", "success");
                    if (isUserLoggedIn) {
                        $.ajax({
                            type: 'GET',
                            url: `http://localhost:8080/api/getAllCart`,
                            dataType: 'json',
                            success: function (data) {
                                $(".js-show-cart").attr("data-notify", data.length);
                                localStorage.setItem("cartQuantity", (data.length).toString());
                            }
                        });
                    }
                },
                error: function (xhr, status, error) {
                    $('#loading-overlay').hide();
                    swal("Lỗi", xhr.responseJSON.message, "error");
                    $('.num-product').val(1);
                }
            });
        }

        function checkColorAndSizeSelect() {
            if ($("#colorSelect").val() == "" || $("#sizeSelect").val() == "") {
                swal("Lỗi", "Vui lòng chọn màu sắc và kích thước trước khi thêm vào giỏ", "error");
                return false;
            }
            return true;
        }
        /*]]>*/
    </script>
</div>
</body>
</html>